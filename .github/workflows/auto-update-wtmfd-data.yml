name: Auto-update wtmfd_data.json from Datamine (main branch)

on:
  schedule:
    - cron: '0 0 * * *'  # Ежедневно в 00:00 UTC
  workflow_dispatch:     # Возможность запуска вручную

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout war_thunder_plane_data repo
        uses: actions/checkout@v4
        with:
          path: script-repo

      - name: Checkout War-Thunder-Datamine
        uses: actions/checkout@v4
        with:
          repository: gszabi99/War-Thunder-Datamine
          ref: master         # ← Исправлено: не main, а master!
          path: script-repo/War-Thunder-Datamine-master
          fetch-depth: 1
      - name: Checkout WT-MFD repo (main branch)
        uses: actions/checkout@v4
        with:
          repository: Sergey-Titkov/WT-MFD
          ref: main
          token: ${{ secrets.WTMFD_PAT }}
          path: WT-MFD

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install packaging
          pip install war_thunder_plane_info
      - name: Run data generation script
        run: |
          cd script-repo
          python make_file_for_wtmfd.py

      - name: Copy generated files to WT-MFD
        run: |
          cp script-repo/wtmfd_data.json WT-MFD/
          cp script-repo/wtmfd_data_version.json WT-MFD/

      - name: Commit and push if changed
        run: |
          cd WT-MFD
          git add wtmfd_data.json wtmfd_data_version.json
          if ! git diff --staged --quiet; then
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            # Извлекаем версию для коммита
            VERSION=$(jq -r '.Version' wtmfd_data_version.json)
            git commit -m "chore: auto-update wtmfd_data.json from Datamine (v${VERSION})"
            git push origin main
          else
            echo "No changes detected. Skipping push."
          fi          